version: 2.1

orbs:
  macos: circleci/macos@2.3.4

executors:
  mac:
    macos:
      xcode: 14.1.0 
      resource_class: macos.x86.medium.gen2
commands:
  capture:
    parameters:
      after:
        type: integer
        default: 60
    steps:
      - run: sleep << parameters.after >>
      - run: screencapture -C captured_<< parameters.after >>.png
      - store_artifacts:
          path: captured_<< parameters.after >>.png
      - store_artifacts:
          path: ~/screencapture
jobs:
  screencapture:
    executor: mac
    steps:
      - macos/enable-vnc
      - macos/add-uitest-permissions
      - macos/add-permission:
          bundle-id: "com.apple.Terminal"
          permission-type: "kTCCServiceScreenCapture"
      # ref: https://support.circleci.com/hc/en-us/articles/4405324304155
      - run: /Library/Application\ Support/VMware\ Tools/vmware-resolutionSet 1024 768
      - macos/list-permissions
      - run: open ~/Documents ~/Desktop ~/Downloads
      - run: open https://google.com
      - run: open https://google.com
      - run: open https://google.com
      - capture:
          after: 20
      - run:
          name: Capture Screen Recording
          command: |
            touch ~/screencapture/tmp.sh
            echo "screencapture -V30 ~/screencapture/wow_so_hacky.mov" > ~/screencapture/tmp.sh
            chmod 755 ~/screencapture/tmp.sh
            open -a Terminal ~/screencapture/tmp.sh
          # Creates shell script, changes permission of script and launches using Terminal

workflows:
  main:
    jobs:
      - screencapture
